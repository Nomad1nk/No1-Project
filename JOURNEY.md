# BEDEL AI BOX - Хөгжүүлэлтийн Түүх ба Шийдлүүд

Энэхүү баримт бичиг нь BEDEL AI BOX төслийг хөгжүүлэх явцад тулгарсан гол асуудлууд, тэдгээрийг хэрхэн шийдвэрлэсэн, болон системийн одоогийн архитектурыг тайлбарлах болно.

## 1. Төслийн Зорилго
Хэрэглэгчийн дуудлагыг хүлээн авч, хиймэл оюун ухаан (OpenAI) ашиглан хариулж, Монгол хэлээр (Chimege TTS) харилцан яриа өрнүүлэх чадвартай SIP/RTP суурилсан AI Receptionist системийг бүтээх.

## 2. Гол Асуудлууд ба Шийдлүүд

### 2.1. WebRTC VAD (Voice Activity Detection) Асуудал
*   **Асуудал:** `webrtcvad` сан нь хэрэглэгчийн яриаг "чимээгүй" гэж буруу таньж, яриаг дутуу таслах эсвэл огт сонсохгүй байх тохиолдол гарсан.
*   **Шийдэл:** Бид VAD-ийг RMS (Root Mean Square) буюу дууны хүч хэмжигчтэй хослуулсан. Сүүлдээ VAD-ийг бүрмөсөн идэвхгүй болгож, зөвхөн `RMS > SILENCE_THRESHOLD` (босго 60-100) нөхцөлөөр яриаг илрүүлдэг болгосон. Энэ нь илүү найдвартай байсан.

### 2.2. Docker NAT болон RTP Урсгал
*   **Асуудал:** Docker дотор ажиллаж буй AI нь гаднаас ирж буй RTP (аудио) багцыг хүлээж авч байсан ч, хариу илгээхдээ Docker Gateway IP (172.18.0.1) ашиглаж байсан тул хэрэглэгчийн утас (192.168.x.x) руу дуу очихгүй байсан.
*   **Шийдэл:**
    1.  `RTP_TARGET_IP` тохиргоог нэмж, хариу илгээх IP хаягийг гараар зааж өгөх боломжтой болгосон.
    2.  "Promiscuous RTP Mode" буюу ирж буй RTP багцын IP хаягийг динамикаар бүртгэж, хариуг тухайн хаяг руу буцааж илгээх логикийг `rtp_loop` дотор хэрэгжүүлсэн.

### 2.3. Chimege TTS "Special Characters" Алдаа
*   **Асуудал:** Chimege TTS API нь тоо (`0-9`) болон зарим тусгай тэмдэгтүүдийг (`$`, `%`, `,`) дэмждэггүй тул "The text contains special characters" гэсэн алдаа буцааж байсан.
*   **Шийдэл:** `src/utils.py` дотор `clean_text_for_tts` функцийг хөгжүүлсэн:
    1.  Тусгай тэмдэгтүүдийг үгээр солих (`%` -> `хувь`, `$` -> `доллар`).
    2.  Тоог бүрэн хэмжээгээр Монгол үг рүү хөрвүүлэх функцийг бичсэн (`252,500` -> `хоёр зуун тавин хоёр мянган таван зуу`).
    3.  Зөвхөн Кирилл үсэг болон цөөн хэдэн тэмдэгтийг зөвшөөрөх шүүлтүүр хийсэн.

### 2.4. Хэлний Төөрөгдөл (Language Hallucination)
*   **Асуудал:** AI заримдаа Казах эсвэл өөр хэлээр хариулж эхэлсэн.
*   **Шийдэл:** `data/system_prompt.txt` дотор "ЗӨВХӨН КИРИЛЛ МОНГОЛООР хариул" гэсэн хатуу дүрмийг оруулж өгсөн.

### 2.5. Түр Зуурын Файлуудын Цэвэрлэгээ
*   **Асуудал:** Дуудлага бүрт `input_*.wav` болон `response_*.wav` файлууд үүсч, дискийг дүүргэж байсан.
*   **Шийдэл:** `process_ai` функцийн төгсгөлд эдгээр файлуудыг автоматаар устгах `os.remove` кодыг нэмсэн.

## 3. Системийн Бүтэц

*   **src/main.py:** Үндсэн програм. SIP болон RTP серверүүдийг асааж, ирж буй дуудлагыг зохицуулна.
*   **src/session.py:** Дуудлага бүрийн төлөв (CallState), аудио буфер, VAD тохиргоог хадгална.
*   **src/utils.py:** Текстийг цэвэрлэх, тоог үг рүү хөрвүүлэх туслах функцууд.
*   **src/config.py:** Бүх тохиргоо (IP, Port, API Keys) энд байрлана.
*   **src/database.py:** Барааны үнэ, үлдэгдэл шалгах SQLite баазын ажиллагаа.
*   **src/tools.py:** OpenAI Function Calling-д зориулсан хэрэгслүүд (`check_price`, `place_order`).

## 4. Цаашдын Хөгжүүлэлт
*   VAD-ийг сайжруулах (Machine Learning суурилсан VAD ашиглах).
*   Олон хэрэглэгч зэрэг залгах үеийн ачааллыг турших.
*   Web Interface дээр дуудлагын түүх, бичлэгийг хадгалах, тоглуулах боломж нэмэх.

---
*Хөгжүүлсэн: Bayasgalan*
*Огноо: 2025-12-03*
